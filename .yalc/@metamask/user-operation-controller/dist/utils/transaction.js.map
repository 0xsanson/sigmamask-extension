{"version":3,"file":"transaction.js","sourceRoot":"","sources":["../../src/utils/transaction.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable no-nested-ternary */\n/* eslint-disable jsdoc/require-jsdoc */\n\nimport type {\n  TransactionError,\n  TransactionMeta,\n  TransactionParams,\n  TransactionType,\n} from '@metamask/transaction-controller';\nimport {\n  TransactionStatus,\n  UserFeeLevel,\n} from '@metamask/transaction-controller';\nimport type { Hex } from '@metamask/utils';\nimport { BN, addHexPrefix, stripHexPrefix } from 'ethereumjs-util';\n\nimport { UserOperationStatus } from '../types';\nimport type { UserOperationMetadata } from '../types';\n\nexport function getTransactionMetadata(\n  metadata: UserOperationMetadata,\n): TransactionMeta | undefined {\n  const {\n    actualGasCost,\n    actualGasUsed,\n    baseFeePerGas,\n    chainId,\n    error: rawError,\n    transactionHash,\n    id,\n    time,\n    transactionParams,\n    userOperation,\n    userFeeLevel: originalUserFeeLevel,\n  } = metadata;\n\n  if (!transactionParams) {\n    return undefined;\n  }\n\n  const { nonce } = userOperation ?? {};\n\n  const effectiveGasPrice =\n    actualGasCost && actualGasUsed\n      ? addHexPrefix(\n          new BN(stripHexPrefix(actualGasCost), 16)\n            .div(new BN(stripHexPrefix(actualGasUsed), 16))\n            .toString(16),\n        )\n      : undefined;\n\n  const error = (\n    rawError\n      ? {\n          name: rawError.name,\n          message: rawError.message,\n          stack: rawError.stack,\n          code: (rawError as any).code,\n          rpc: (rawError as any).rpc,\n        }\n      : undefined\n  ) as TransactionError;\n\n  const status: TransactionStatus = {\n    [UserOperationStatus.Unapproved]: TransactionStatus.unapproved,\n    [UserOperationStatus.Approved]: TransactionStatus.approved,\n    [UserOperationStatus.Signed]: TransactionStatus.signed,\n    [UserOperationStatus.Submitted]: TransactionStatus.submitted,\n    [UserOperationStatus.Confirmed]: TransactionStatus.confirmed,\n    [UserOperationStatus.Failed]: TransactionStatus.failed,\n  }[metadata.status];\n\n  const gas = addHex(\n    userOperation?.preVerificationGas,\n    userOperation?.verificationGasLimit,\n    userOperation?.callGasLimit,\n  );\n\n  const hasPaymaster = userOperation.paymasterAndData !== '0x';\n\n  const maxFeePerGas = hasPaymaster\n    ? '0x0'\n    : userOperation.maxFeePerGas === '0x'\n    ? undefined\n    : userOperation.maxFeePerGas;\n\n  const maxPriorityFeePerGas = hasPaymaster\n    ? '0x0'\n    : userOperation.maxPriorityFeePerGas === '0x'\n    ? undefined\n    : userOperation.maxPriorityFeePerGas;\n\n  const userFeeLevel = hasPaymaster\n    ? UserFeeLevel.CUSTOM\n    : originalUserFeeLevel;\n\n  const txParams = {\n    ...transactionParams,\n    from: userOperation.sender,\n    gas,\n    nonce,\n    maxFeePerGas,\n    maxPriorityFeePerGas,\n  } as TransactionParams;\n\n  // Since the user operations only support EIP-1559, we won't need this.\n  delete txParams.gasPrice;\n\n  const type = 'userOperation' as TransactionType;\n\n  return {\n    baseFeePerGas: (baseFeePerGas as Hex) ?? undefined,\n    chainId: chainId as Hex,\n    error,\n    hash: transactionHash ?? undefined,\n    id,\n    txReceipt: {\n      effectiveGasPrice: effectiveGasPrice ?? undefined,\n      gasUsed: actualGasUsed ?? undefined,\n    },\n    status,\n    time,\n    txParams,\n    type,\n    userFeeLevel: userFeeLevel || undefined,\n  };\n}\n\nfunction addHex(...values: (string | undefined)[]) {\n  const total = new BN(0);\n\n  for (const value of values) {\n    if (!value) {\n      continue;\n    }\n\n    total.iadd(new BN(stripHexPrefix(value), 16));\n  }\n\n  return addHexPrefix(total.toString(16));\n}\n"]}