{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/snaps/simple-account/index.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable jsdoc/require-jsdoc */\n/* eslint-disable @typescript-eslint/no-non-null-assertion */\n/* eslint-disable n/no-process-env */\n\nimport { Web3Provider } from '@ethersproject/providers';\nimport { createModuleLogger } from '@metamask/utils';\n\nimport { ENTRYPOINT } from '../../constants';\nimport { projectLogger } from '../../logger';\nimport type {\n  OnPaymasterHandler,\n  OnUserOperationHandler,\n  OnUserOperationSignatureHandler,\n} from '../types';\nimport { BUNDLER_URL_BY_CHAIN_ID } from './constants';\nimport { signUserOperation } from './ecdsa';\nimport {\n  getCallData,\n  getDummySignature,\n  getInitCode,\n  getNonce,\n  getSender,\n} from './SimpleAccount';\nimport {\n  getDummyPaymasterAndData,\n  getPaymasterAndData,\n} from './VerifyingPaymaster';\n\nconst log = createModuleLogger(projectLogger, 'simple-account-snap');\n\nconst onUserOperationRequest: OnUserOperationHandler = async (request) => {\n  log('Received user operation request');\n\n  const { chainId, data, ethereum, to, value } = request;\n\n  const provider = new Web3Provider(ethereum as any);\n\n  const potentialInitCode = getInitCode(\n    process.env.SIMPLE_ACCOUNT_OWNER!,\n    process.env.SIMPLE_ACCOUNT_SALT!,\n  );\n\n  const sender = await getSender(potentialInitCode, provider);\n  const callData = getCallData(to, value, data, sender);\n  const code = await provider.getCode(sender);\n  const isDeployed = Boolean(code) && code !== '0x';\n  const initCode = isDeployed ? '0x' : potentialInitCode;\n  const nonce = await getNonce(sender, isDeployed, provider);\n  const bundler = getBundler(chainId);\n  const dummySignature = getDummySignature();\n  const dummyPaymasterAndData = getDummyPaymasterAndData();\n\n  return {\n    bundler,\n    callData,\n    dummyPaymasterAndData,\n    dummySignature,\n    initCode,\n    nonce,\n    sender,\n  };\n};\n\nconst onPaymasterRequest: OnPaymasterHandler = async (request) => {\n  log('Received paymaster request', {\n    paymasterAddress: process.env.PAYMASTER_ADDRESS,\n  });\n\n  const { userOperation, ethereum, privateKey } = request;\n  const provider = new Web3Provider(ethereum as any);\n  const paymasterAddress = process.env.PAYMASTER_ADDRESS;\n\n  const paymasterAndData = paymasterAddress\n    ? await getPaymasterAndData(\n        paymasterAddress,\n        0,\n        0,\n        userOperation,\n        privateKey,\n        provider,\n      )\n    : '0x';\n\n  if (!paymasterAddress) {\n    log('Skipping paymaster');\n  }\n\n  return { paymasterAndData };\n};\n\nconst onUserOperationSignatureRequest: OnUserOperationSignatureHandler = async (\n  request,\n) => {\n  log('Received user operation signature request');\n\n  const { chainId, privateKey, userOperation } = request;\n\n  const signature = await signUserOperation(\n    userOperation,\n    ENTRYPOINT,\n    chainId,\n    privateKey,\n  );\n\n  return {\n    signature,\n  };\n};\n\nfunction getBundler(chainId: string): string | undefined {\n  return (BUNDLER_URL_BY_CHAIN_ID as any)[chainId];\n}\n\nexport default {\n  onUserOperationRequest,\n  onPaymasterRequest,\n  onUserOperationSignatureRequest,\n};\n"]}